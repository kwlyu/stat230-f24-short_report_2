---
title: "Short Report 2 Code"
author: "Anna Ursin and Kunwu Lyu"
date: "`r Sys.Date()`"
output: pdf_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = T)
library(tidyverse)
library(ggplot2)
library(GGally)
library(ggResidpanel)
library(broom)
library(patchwork)
library(purrr)
library(car)
```


```{r}
## Data Wrangling

wine_dat <- read.csv("https://www.math.carleton.edu/ckelling/data/wine_project.csv")
glimpse(wine_dat)


ggpairs(wine_dat)
```

```{r}
##EDA: boxplots
library(ggplot2)
ggplot(wine_dat, aes(y = fixed.acidity)) + geom_boxplot() + ggtitle("Fixed Acidity")
ggplot(wine_dat, aes(y = volatile.acidity)) + geom_boxplot() + ggtitle("Volatile Acidity")
ggplot(wine_dat, aes(y = citric.acid)) + geom_boxplot() + ggtitle("Citric Acid")
ggplot(wine_dat, aes(y = residual.sugar)) + geom_boxplot() + ggtitle("Residual Sugar")
ggplot(wine_dat, aes(y = chlorides)) + geom_boxplot() + ggtitle("Chlorides")
ggplot(wine_dat, aes(y = free.sulfur.dioxide)) + geom_boxplot() + ggtitle("Free Sulfur Dioxide")
ggplot(wine_dat, aes(y = total.sulfur.dioxide)) + geom_boxplot() + ggtitle("Total Sulfur Dioxide")
ggplot(wine_dat, aes(y = density)) + geom_boxplot() + ggtitle("Density")
ggplot(wine_dat, aes(y = pH)) + geom_boxplot() + ggtitle("pH")
ggplot(wine_dat, aes(y = sulphates)) + geom_boxplot() + ggtitle("Sulphates")
ggplot(wine_dat, aes(y = alcohol)) + geom_boxplot() + ggtitle("Alcohol")
ggplot(wine_dat, aes(y = quality)) + geom_boxplot() + ggtitle("Quality")
ggplot(wine_dat, aes(x = color, fill = color)) +
  geom_bar(position = "dodge")
```


```{r}
#dist of quality scores
ggplot(wine_dat, aes(x = quality)) + 
  geom_bar() + 
  labs(title = "Distribution of Wine Quality Scores")
```

```{r}
#scatterplots for predictors vs wine quality
create_plot <- function(var_name) {
  ggplot(data = wine_dat, 
         aes_string(x = var_name, y = "quality")) +
    geom_point(alpha = 0.1) +
    geom_smooth(method = "lm", se = FALSE) + 
    labs(title = paste("Quality vs", var_name))
}

variable_names <- c("alcohol", "sulphates", "pH", "residual.sugar")
plot_list <- map(variable_names, create_plot)

plot_grid <- wrap_plots(plot_list, ncol = 2)
plot_grid
```


```{r}
#correlation matrix
library(corrplot)

wine_numeric <- wine_dat %>% select(-color)

corr_matrix <- cor(wine_numeric, use = "complete.obs")
corrplot(corr_matrix, method = "color")

#checking for VIF - must use base model, not interaction model
vif(wine_lmbase)
vif(lm(quality ~ alcohol + sulphates + residual.sugar + pH + color, data = wine_dat)) # I think it should be this one; the base model doesn't have a color term
```

```{r}
#residual plots by color
ggplot(data = data.frame(Residuals = residuals(interactionmodel), Color = wine_dat$color), 
       aes(x = Color, y = Residuals, fill = Color)) +
  geom_boxplot() +
  geom_hline(yintercept = 0, color = "red", linetype = "dashed") +
  labs(title = "Residuals by Wine Color", x = "Wine Color", y = "Residuals") +
  theme_minimal()
```


```{r}
# Scatterplot matrix
ggpairs(data = wine_dat, columns = c("alcohol", "sulphates", "pH", "residual.sugar", "quality"))

create_plot <- function(var_name) {
  ggplot(data = wine_dat, 
         aes_string(x = var_name, y = "quality", color = "color")) +
    geom_point(alpha = 0.1) +
    geom_smooth(method = "lm", se = FALSE) + 
    labs(title = paste("Quality vs", var_name))
}

variable_names <- c("alcohol", "sulphates", "pH", "residual.sugar")
plot_list <- map(variable_names, create_plot)

plot_grid <- wrap_plots(plot_list, ncol = 2)
plot_grid
```

```{r}
#figuring out outliers based on scatterplot matrix
mean_values <- wine_dat %>%
  summarize(across(c(alcohol, sulphates, pH, residual.sugar, citric.acid, fixed.acidity), mean, na.rm = TRUE))
mean_values

row_num <- 4381
case_values <- wine_dat[row_num, c("alcohol", "sulphates", "pH", "residual.sugar", "citric.acid", "fixed.acidity")]
case_values
#This case has a very large residual sugar
```

```{r}
#making an interaction model
interactionmodel <- lm(quality ~ alcohol + sulphates + residual.sugar + pH*color, data = wine_dat)
summary(interactionmodel)
confint(interactionmodel)

wine_dat_no_outliers <- wine_dat %>%
  filter(residual.sugar != 65.8)
winenooutlierslm <- lm(quality ~ alcohol + sulphates + residual.sugar + pH*color, data = wine_dat_no_outliers)
summary(winenooutlierslm)

create_inf_plot <- function(var_name) {
  ggplot(data = wine_dat, 
         aes_string(x = var_name, y = "quality")) +
    geom_point() +
    geom_smooth(method = "lm", se = FALSE, color = "blue") +
    geom_point(data = wine_dat %>% filter(residual.sugar == 65.8), 
               color = "red") +
    geom_smooth(data = wine_dat %>% filter(residual.sugar == 65.8), 
                method = "lm", se = FALSE, color = "red") +
    labs(title = paste("Plot of Quality vs", var_name))
}

plot_list2 <- map(variable_names, create_inf_plot)

plot_grid2 <- wrap_plots(plot_list2, ncol = 2)
plot_grid2
```



```{r}
#Basefunction
wine_lmbase <- lm(quality ~ alcohol + sulphates + residual.sugar + pH, data = wine_dat)
summary(wine_lmbase)
AIC(wine_lmbase)
wine_lminteraction <- lm(quality ~ alcohol + sulphates + residual.sugar + pH*color, data = wine_dat)
summary(wine_lminteraction)
confint(wine_lminteraction)
AIC(wine_lminteraction)
AIC(interactionmodel)
```

```{r}
# linear comb for white wine ph
wine_lminteraction$coefficients[5] -> redPH
wine_lminteraction$coefficients[7] -> whtPH_int

whtPH <- (redPH + whtPH_int)[[1]]

vcov(wine_lminteraction)[c(5, 7), c(5, 7)] -> ph_cov

ph_se <- sqrt(ph_cov[[1, 1]] + ph_cov[[2, 2]] + 2 * ph_cov[[1, 2]])

test_stat <- whtPH/ph_se
2*pt(test_stat, df = 6497 - 7, lower.tail = F)

```



```{r}
#checking for influential observations
wine_datrow <- wine_dat %>% mutate(case = row_number())
AUGwine_lminteraction <- augment(wine_lminteraction_tran, data = wine_datrow)


ggplot(data = AUGwine_lminteraction, aes(x = case, y = .cooksd)) + 
  geom_point() + 
  geom_point(data = AUGwine_lminteraction %>% filter(case == 4381), color = "blue") + 
  geom_hline(yintercept=1, linetype="dashed", color = "red")  + 
  labs(y = "Cook's Distance", x = "Index") -> cookDistancePlot


ggplot(AUGwine_lminteraction, aes(x = case, y = .std.resid)) + geom_point() + 
  geom_point(data = AUGwine_lminteraction %>% filter(case == 4381), color = "blue") + 
  geom_hline(yintercept=3, linetype="dashed", color = "red")  + 
  geom_hline(yintercept=-3, linetype="dashed", color = "red")  + 
  labs(y = "Studentized Residuals", x = "Index") -> studResiPlot

ggplot(AUGwine_lminteraction, aes(x = case, y = .hat)) + geom_point() + 
  geom_point(data = AUGwine_lminteraction %>% filter(case == 4381), color = "blue") + 
  geom_hline(yintercept=2*7/6497, linetype="dashed", color = "red")  + 
  labs(y = "Leverage", x = "Index") -> leveragePlot

cookDistancePlot|studResiPlot|leveragePlot 

high_L <- AUGwine_lminteraction %>% select(case, .hat) %>% 
  arrange(desc(.hat)) %>%
  filter(.hat > 2*7/6497)
high_SR <- AUGwine_lminteraction %>% select(case, .std.resid) %>% 
  arrange(desc(.std.resid)) %>% 
  filter(.std.resid > 3)
high_CD <- AUGwine_lminteraction %>% select(case, .cooksd) %>% 
  arrange(desc(.cooksd)) %>% 
  filter(.cooksd > 1)
high_L
high_SR
#case 2374 is high, above 4
high_CD
```

```{r}
#model comparison: interaction vs base, untransformed
anova(wine_lmbase, wine_lminteraction)
```

```{r}
#model comparison using AIC
AICbase <- AIC(wine_lmbase)
AICinteraction <- AIC(wine_lminteraction)
AICbase
AICinteraction
```


```{r}
set.seed(67393937)
#backwards selection

upper_model <- lm(quality ~ (pH + alcohol + residual.sugar + color + sulphates + fixed.acidity + volatile.acidity + citric.acid + chlorides + free.sulfur.dioxide + total.sulfur.dioxide + density)^2,
                 data = wine_dat)
lower_model <- lm(quality ~ 1, data = wine_dat)

library(MASS)
backwardSelectModel <- stepAIC(upper_model, scope = list(lower = lower_model, 
                                                         upper = upper_model),
                               direction = "backward")
summary(backwardSelectModel)

forwardSelectModel <- stepAIC(upper_model, scope = list(lower = lower_model, 
                                                         upper = upper_model),
                               direction = "forward")
summary(forwardSelectModel)

anova(wine_lminteraction, forwardSelectModel)
anova(wine_lminteraction, backwardSelectModel)
```

```{r}
#Residual Plots
library(ggResidpanel)
resid_panel(wine_lminteraction, plots = c("hist", "qq", "resid"), smoother = T)
resid_panel(wine_lminteraction, plots = "resid", smoother = TRUE)
resid_xpanel(wine_lminteraction, smoother = TRUE)

wine_lm_aug <- augment(wine_lminteraction, newdata = wine_dat)
wine_lm_res2 <- ggplot(wine_lm_aug, aes(x = sulphates, y = .resid)) + 
  geom_point(alpha = 0.3) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "blue") + 
  geom_smooth(method = "loess", color = "red") +
  labs(x = "Sulphates", y = "residuals")
wine_lm_res3 <- ggplot(wine_lm_aug, aes(x = residual.sugar, y = .resid)) + 
  geom_point(alpha = 0.3) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "blue") + 
  geom_smooth(method = "loess", color = "red") +
  labs(x = "Residual Sugar", y = "residuals")
combined_plot <- (wine_lm_res2 | wine_lm_res3) 
  combined_plot + 
    plot_layout(guides = 'collect') + 
    plot_annotation(title = "Selected Residual Plot of Wine Quality MLR")
combined_plot
# 
create_res_plot <- function(data) {
  # augment data for plotting
  wine_lm_aug <- augment(data, newdata = wine_dat)
  if (identical(data, wine_lminteraction_tran)) {
    wine_lm_aug$var_sul <- log(wine_lm_aug$sulphates)
    wine_lm_aug$var_sug <- log(wine_lm_aug$residual.sugar)
    sul_name <- "Log(Sulphates)"
    sug_name <- "Log(Residual Sugar)"
  } else {
    wine_lm_aug$var_sul <- wine_lm_aug$sulphates
    wine_lm_aug$var_sug <- wine_lm_aug$residual.sugar
    sul_name <- "Sulphates"
    sug_name <- "Residual Sugar"
  }
  # residual plot
  wine_lm_res1 <- ggplot(wine_lm_aug, aes(x = alcohol, y = .resid)) + 
    geom_point(alpha = 0.3) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "blue") + 
    geom_smooth(method = "loess", color = "red") +
    labs(x = "Alcohol Content", y = "residuals")
  
  wine_lm_res2 <- ggplot(wine_lm_aug, aes(x = var_sul, y = .resid)) + 
    geom_point(alpha = 0.3) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "blue") + 
    geom_smooth(method = "loess", color = "red") +
    labs(x = sul_name, y = "residuals")
  
  wine_lm_res3 <- ggplot(wine_lm_aug, aes(x = var_sug, y = .resid)) + 
    geom_point(alpha = 0.3) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "blue") + 
    geom_smooth(method = "loess", color = "red") +
    labs(x = sug_name, y = "residuals")
  
  wine_lm_res4 <- ggplot(wine_lm_aug, aes(x = pH, y = .resid)) + 
    geom_point(alpha = 0.3) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "blue") + 
    geom_smooth(method = "loess", color = "red") +
    labs(x = "pH Levels", y = "residuals")
  
  wine_lm_res5 <- ggplot(wine_lm_aug, aes(x = color, y = .resid)) + 
    geom_boxplot() +
    geom_hline(yintercept = 0, linetype = "dashed", color = "blue") + 
    labs(x = "Wine Color", y = "residuals")
  
  wine_lm_res6 <- ggplot(wine_lm_aug, aes(x = .fitted, y = .resid)) + 
    geom_point(alpha = 0.3) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "blue") + 
    geom_smooth(method = "loess", color = "red") + 
    labs(x = "Fitted Values", y = "residuals")
  
  # normal qq plot
  wine_lm_qq <- ggplot(wine_lm_aug, aes(sample = .resid))+
    geom_qq() +
    geom_qq_line(color = "blue") +
    labs(y = "Sample Quantiles", x = "Normal Quantiles")
  
  combined_plot <- (wine_lm_res1 | wine_lm_res2 | wine_lm_res3) / (wine_lm_res4 | wine_lm_res5 | wine_lm_res6) / wine_lm_qq
  combined_plot + 
    plot_layout(guides = 'collect') + 
    plot_annotation(title = "Residual Plot and Normal Q-Q Plot of Wine Quality MLR")
}

create_res_plot(wine_lminteraction)
```


```{r}
# transformed model

wine_lminteraction_tran <- lm(quality ~ alcohol + log(sulphates) + log(residual.sugar) + pH*color, data = wine_dat)
summary(wine_lminteraction_tran)
AIC(wine_lminteraction_tran)
create_res_plot(wine_lminteraction_tran)

confint(wine_lminteraction_tran)
confint(wine_lminteraction_tran)*log(2)
```


```{r}
# linear comb for white wine ph
wine_lminteraction_tran$coefficients[5] -> redPH
wine_lminteraction_tran$coefficients[7] -> whtPH_int

whtPH <- (redPH + whtPH_int)[[1]]

vcov(wine_lminteraction_tran)[c(5, 7), c(5, 7)] -> ph_cov

ph_se <- sqrt(ph_cov[[1, 1]] + ph_cov[[2, 2]] + 2 * ph_cov[[1, 2]])

test_stat <- whtPH/ph_se
2*pt(test_stat, df = 6497 - 7, lower.tail = F)

wht_ci <- whtPH + c(-1, 1)*qt(0.975, df = 6497 - 7, )*ph_se

wine_lminteraction_tran$coefficients[3] * log(2)
wine_lminteraction_tran$coefficients[4] * log(2)
```

```{r}
#model comparison with transformed model
wine_lmbasetran <- lm(quality ~ alcohol + log(sulphates) + log(residual.sugar) + pH, data = wine_dat)
anova( wine_lmbasetran, wine_lminteraction_tran)
summary(wine_lminteraction_tran)
AIC(wine_lminteraction_tran)
```

