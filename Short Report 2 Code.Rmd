---
title: "Short Report 2 Code"
author: "Anna Ursin and Kunwu Lyu"
date: "`r Sys.Date()`"
output: pdf_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = T)
library(tidyverse)
library(ggplot2)
library(GGally)
library(broom)
library(patchwork)
library(purrr)
```


```{r}
## Data Wrangling

wine_dat <- read.csv("https://www.math.carleton.edu/ckelling/data/wine_project.csv")
glimpse(wine_dat)


ggpairs(wine_dat)
```

```{r}
##EDA: boxplots
library(ggplot2)
ggplot(wine_dat, aes(y = fixed.acidity)) + geom_boxplot() + ggtitle("Fixed Acidity")
ggplot(wine_dat, aes(y = volatile.acidity)) + geom_boxplot() + ggtitle("Volatile Acidity")
ggplot(wine_dat, aes(y = citric.acid)) + geom_boxplot() + ggtitle("Citric Acid")
ggplot(wine_dat, aes(y = residual.sugar)) + geom_boxplot() + ggtitle("Residual Sugar")
ggplot(wine_dat, aes(y = chlorides)) + geom_boxplot() + ggtitle("Chlorides")
ggplot(wine_dat, aes(y = free.sulfur.dioxide)) + geom_boxplot() + ggtitle("Free Sulfur Dioxide")
ggplot(wine_dat, aes(y = total.sulfur.dioxide)) + geom_boxplot() + ggtitle("Total Sulfur Dioxide")
ggplot(wine_dat, aes(y = density)) + geom_boxplot() + ggtitle("Density")
ggplot(wine_dat, aes(y = pH)) + geom_boxplot() + ggtitle("pH")
ggplot(wine_dat, aes(y = sulphates)) + geom_boxplot() + ggtitle("Sulphates")
ggplot(wine_dat, aes(y = alcohol)) + geom_boxplot() + ggtitle("Alcohol")
ggplot(wine_dat, aes(y = quality)) + geom_boxplot() + ggtitle("Quality")
ggplot(wine_dat, aes(x = color, fill = color)) +
  geom_bar(position = "dodge")
```


```{r}
#dist of quality scores
ggplot(wine_dat, aes(x = quality)) + 
  geom_bar() + 
  labs(title = "Distribution of Wine Quality Scores")
ggplot(wine_dat, aes(y = residual.sugar)) + geom_boxplot() + ggtitle("Residual Sugar")
```

```{r}
#correlation matrix
library(corrplot)
library(car)

wine_numeric <- wine_dat %>% select(-color)

corr_matrix <- cor(wine_numeric, use = "complete.obs")
corrplot(corr_matrix, method = "color")

#checking for VIF - must use base model, not interaction model
vif(wine_lmbase)
```

```{r}
#Basefunction
wine_lmbase <- lm(quality ~ alcohol + sulphates + residual.sugar + pH, data = wine_dat)
summary(wine_lmbase)
```


```{r}
# Scatterplot matrix
ggpairs(data = wine_dat, columns = c("alcohol", "sulphates", "pH", "residual.sugar", "quality"))

create_plot <- function(var_name) {
  ggplot(data = wine_dat, 
         aes_string(x = var_name, y = "quality", color = "color")) +
    geom_point() +
    geom_smooth(method = "lm", se = FALSE) + 
    labs(title = paste("Quality vs", var_name))
}

variable_names <- c("alcohol", "sulphates", "pH", "residual.sugar")
plot_list <- map(variable_names, create_plot)

plot_grid <- wrap_plots(plot_list, ncol = 2)
plot_grid
```
```{r}
#figuring out outliers based on scatterplot matrix
mean_values <- wine_dat %>%
  summarize(across(c(alcohol, sulphates, pH, residual.sugar, citric.acid, fixed.acidity), mean, na.rm = TRUE))
mean_values

row_num <- 4381
case_values <- wine_dat[row_num, c("alcohol", "sulphates", "pH", "residual.sugar", "citric.acid", "fixed.acidity")]
case_values
#This case has a very large residual sugar
```
```{r}
#making an interaction model
interactionmodel <- lm(quality ~ alcohol + sulphates + residual.sugar + pH*color, data = wine_dat)
summary(interactionmodel)
confint(interactionmodel)
```



```{r}
#checking for influential observations
wine_datrow <- wine_dat %>% mutate(case = row_number())
AUGwine_lminteraction <- augment(wine_lminteraction, data = wine_datrow)


ggplot(data = AUGwine_lminteraction, aes(x = case, y = .cooksd)) + 
  geom_point() + 
  geom_point(data = AUGwine_lminteraction %>% filter(case == 4381), color = "blue") + 
  geom_hline(yintercept=1, linetype="dashed", color = "red")  + 
  labs(y = "Cook's Distance", x = "Index") -> cookDistancePlot


ggplot(AUGwine_lminteraction, aes(x = case, y = .std.resid)) + geom_point() + 
  geom_point(data = AUGwine_lminteraction %>% filter(case == 4381), color = "blue") + 
  geom_hline(yintercept=3, linetype="dashed", color = "red")  + 
  geom_hline(yintercept=-3, linetype="dashed", color = "red")  + 
  labs(y = "Studentized Residuals", x = "Index") -> studResiPlot

ggplot(AUGwine_lminteraction, aes(x = case, y = .hat)) + geom_point() + 
  geom_point(data = AUGwine_lminteraction %>% filter(case == 4381), color = "blue") + 
  geom_hline(yintercept=2*7/6497, linetype="dashed", color = "red")  + 
  labs(y = "Leverage", x = "Index") -> leveragePlot

cookDistancePlot|studResiPlot|leveragePlot 

high_L <- AUGwine_lminteraction %>% select(case, .hat) %>% 
  arrange(desc(.hat)) %>%
  filter(.hat > 2*7/6497)
high_SR <- AUGwine_lminteraction %>% select(case, .std.resid) %>% 
  arrange(desc(.std.resid)) %>% 
  filter(.std.resid > 3)
high_CD <- AUGwine_lminteraction %>% select(case, .cooksd) %>% 
  arrange(desc(.cooksd)) %>% 
  filter(.cooksd > 1)
high_L
high_SR
#case 2374 is high, above 4
high_CD
```

```{r}
#model comparison
anova(wine_lmbase, interactionmodel)
```
```{r}
#model comparison using AIC
AICbase <- AIC(wine_lmbase)
AICinteraction <- AIC(interactionmodel)
AICbase
AICinteraction
```


```{r}
#backwards selection

upper_model <- lm(quality ~ (pH + alcohol + residual.sugar + color + sulphates + fixed.acidity + volatile.acidity + citric.acid + chlorides + free.sulfur.dioxide + total.sulfur.dioxide + density)^2,
                 data = wine_dat)
lower_model <- lm(quality ~ 1, data = wine_dat)

library(MASS)
backwardSelectModel <- stepAIC(upper_model, scope = list(lower = lower_model, 
                                                         upper = upper_model),
                               direction = "backward")
summary(backwardSelectModel)

anova(interactionmodel, backwardSelectModel)
```
```{r}
#Residual Plots
library(ggResidpanel)
resid_panel(MRmodel, plots = c("hist", "qq"))
resid_panel(interactionmodel, plots = "resid", smoother = TRUE)
resid_xpanel(interactionmodel, smoother = TRUE)

```

